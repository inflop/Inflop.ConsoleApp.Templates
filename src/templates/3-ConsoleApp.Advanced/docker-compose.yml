version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: consoleapp-modern
    environment:
      - DOTNET_ENVIRONMENT=Development
    restart: unless-stopped
<!--#if (UseSqlServer || UsePostgres || UseRabbitMQ || UseKafka) -->
    depends_on:
<!--#endif -->
<!--#if (UseSqlServer) -->
      - sqlserver
<!--#endif -->
<!--#if (UsePostgres) -->
      - postgres
<!--#endif -->
<!--#if (UseRabbitMQ) -->
      - rabbitmq
<!--#endif -->
<!--#if (UseKafka) -->
      - kafka
<!--#endif -->

<!--#if (UseSqlServer) -->
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: consoleapp-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
    ports:
      - "1433:1433"
    volumes:
      - sqlserver-data:/var/opt/mssql
    restart: unless-stopped
<!--#endif -->

<!--#if (UsePostgres) -->
  postgres:
    image: postgres:16-alpine
    container_name: consoleapp-postgres
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=myapp
      - POSTGRES_USER=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
<!--#endif -->

<!--#if (UseRabbitMQ) -->
  rabbitmq:
    image: rabbitmq:3-management
    container_name: consoleapp-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    restart: unless-stopped
<!--#endif -->

<!--#if (UseKafka) -->
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: consoleapp-zookeeper
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: consoleapp-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
    volumes:
      - kafka-data:/var/lib/kafka/data
    restart: unless-stopped

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: consoleapp-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    restart: unless-stopped
<!--#endif -->

<!--#if (UseSqlServer || UsePostgres || UseRabbitMQ || UseKafka) -->
volumes:
<!--#endif -->
<!--#if (UseSqlServer) -->
  sqlserver-data:
<!--#endif -->
<!--#if (UsePostgres) -->
  postgres-data:
<!--#endif -->
<!--#if (UseRabbitMQ) -->
  rabbitmq-data:
<!--#endif -->
<!--#if (UseKafka) -->
  kafka-data:
<!--#endif -->
